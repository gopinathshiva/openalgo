import{r as c}from"./vendor-react--vsXx8_n.js";import{t as j}from"./trading-CTa0dJYR.js";import{u as W,a as z}from"./useMarketData-BkCpnkL6.js";import{d as V}from"./index-BusRmyyF.js";async function U(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function B(){const[t,f]=c.useState({timings:[],holidays:[],isLoading:!0,error:null});c.useEffect(()=>{(async()=>{try{const e={"X-CSRFToken":await U(),"Content-Type":"application/json"},[r,u]=await Promise.all([fetch("/admin/api/timings",{headers:e,credentials:"include"}),fetch("/admin/api/holidays",{headers:e,credentials:"include"})]),g=await r.json(),w=await u.json();f({timings:g.status==="success"?g.market_status||[]:[],holidays:w.status==="success"?w.data||[]:[],isLoading:!1,error:null})}catch(n){f(e=>({...e,isLoading:!1,error:`Failed to fetch market status: ${n}`}))}})()},[]);const o=c.useCallback(a=>{const n=new Date().toISOString().split("T")[0],e=t.holidays.find(r=>r.date===n);if(!e)return!1;if(e.closed_exchanges.includes(a)){const r=e.open_exchanges.find(u=>u.exchange===a);if(r){const u=Date.now();return!(u>=r.start_time&&u<=r.end_time)}return!0}return!1},[t.holidays]),d=c.useCallback(a=>{if(o(a))return!1;const n=t.timings.find(r=>r.exchange===a);if(!n)return!1;const e=Date.now();return e>=n.start_time&&e<=n.end_time},[t.timings,o]),i=c.useCallback(()=>t.timings.some(a=>{const n=Date.now();return n>=a.start_time&&n<=a.end_time&&!o(a.exchange)}),[t.timings,o]),p=c.useCallback(a=>{if(o(a))return"closed";const n=t.timings.find(u=>u.exchange===a);if(!n)return"closed";const e=Date.now(),r=900*1e3;return e<n.start_time-r?"closed":e<n.start_time?"pre-market":e<=n.end_time?"open":"post-market"},[t.timings,o]);return{isMarketOpen:d,isAnyMarketOpen:i,isHolidayForExchange:o,getMarketStatus:p,timings:t.timings,holidays:t.holidays,isLoading:t.isLoading,error:t.error}}function Z(t,f={}){const{enabled:o=!0,staleThreshold:d=5e3,useMultiQuotesFallback:i=!0,multiQuotesRefreshInterval:p=3e4,pauseWhenHidden:a=!0,pauseDelay:n=5e3}=f,{apiKey:e}=V(),{isMarketOpen:r,isAnyMarketOpen:u}=B(),{isVisible:g,wasHidden:w,timeSinceHidden:C}=W(),L=u(),[_,E]=c.useState(new Map),v=c.useRef(Date.now()),F=c.useMemo(()=>t.map(s=>({symbol:s.symbol,exchange:s.exchange})),[t]),{data:q,isConnected:O,isPaused:H}=z({symbols:F,mode:"LTP",enabled:o&&t.length>0,pauseWhenHidden:a,pauseDelay:n}),A=O&&L&&!H,k=c.useCallback(async()=>{if(!(!e||t.length===0||!i))try{const s=t.map(l=>({symbol:l.symbol,exchange:l.exchange})),m=await j.getMultiQuotes(e,s);if(m.status==="success"&&m.results){const l=new Map;m.results.forEach(h=>{const P=`${h.exchange}:${h.symbol}`;h.data&&l.set(P,h.data)}),E(l)}}catch{}},[e,t,i]);return c.useEffect(()=>{if(!o||t.length===0||!i||a&&!g)return;k(),v.current=Date.now();const s=setInterval(()=>{k(),v.current=Date.now()},p);return()=>clearInterval(s)},[o,t.length,i,k,p,a,g]),c.useEffect(()=>{!w||!g||!i||!o||C>p&&(k(),v.current=Date.now())},[w,g,C,p,i,o,k]),{data:c.useMemo(()=>t.map(s=>{const m=`${s.exchange}:${s.symbol}`,l=q.get(m),h=_.get(m),P=s.quantity!==void 0&&s.quantity!==null,M=s.quantity||0,D=s.average_price||0,Q=r(s.exchange)&&l?.data?.ltp&&l.lastUpdate&&Date.now()-l.lastUpdate<d,I=!Q&&h?.ltp;let y,b="rest";if(Q&&l?.data?.ltp?(y=l.data.ltp,b="websocket"):I&&h?.ltp?(y=h.ltp,b="multiquotes"):(y=s.ltp,b="rest"),P&&M===0)return{...s,_dataSource:"rest"};let x=s.pnl||0,R=s.pnlpercent||0;const $=s.today_realized_pnl||0;if(y&&D>0){let S;M>0?S=(y-D)*M:S=(D-y)*Math.abs(M),x=$+S;const T=Math.abs(D*M);R=T>0?x/T*100:0}return{...s,ltp:y,pnl:x,pnlpercent:R,_dataSource:b}}),[t,q,_,r,d]),isLive:A,isConnected:O,isPaused:H,isAnyMarketOpen:L,multiQuotes:_,refreshMultiQuotes:k}}function tt(t,f){if(!f)return null;let o=0,d=0,i=0;t.forEach(a=>{o+=a.pnl||0;const n=a.average_price||0,e=a.quantity||0,r=a.ltp||n;d+=n*e,i+=r*e});const p=d>0?o/d*100:0;return{...f,totalholdingvalue:i,totalinvvalue:d,totalprofitandloss:o,totalpnlpercentage:p}}export{tt as c,Z as u};
